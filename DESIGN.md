# AI 自主控机系统 - 完整设计文档

## 📋 项目概述

基于 **Shizuku + Qwen3-VL** 的安卓端全自动 AI 控机系统,实现通过自然语言指令让 AI 自主执行复杂的手机操作任务,无需用户编写脚本或反复输入指令。

**核心理念**:让 AI 真正"看懂"手机屏幕,像人类一样自主完成任务。

---

## 🏗️ 核心架构

### 技术栈组成

#### 1. 权限层: Shizuku
- 提供系统级操作能力(无需 root)
- 支持模拟点击、滑动、输入等人类操作
- 可访问无障碍服务、控件树、剪贴板等系统资源

#### 2. 感知层: UI 元素检测
- **视觉理解**: 截图上传至 VLM 进行场景识别
- **结构分析**: 解析 Android 控件树(View Hierarchy)
- **文字提取**: OCR 辅助识别不可访问的文本内容
- **多模态融合**: 将视觉信息和结构化数据结合,为 AI 提供完整的屏幕状态

#### 3. 决策层: VLM 推理引擎
- 使用硅基流动 API 调用 Qwen3-VL 或其他兼容模型
- 基于屏幕状态和任务目标进行推理
- 生成结构化操作指令(JSON 格式)

#### 4. 执行层: 操作执行器
- 接收 AI 决策指令
- 通过 Shizuku 执行具体操作
- 实时反馈执行结果

#### 5. 管理层: 任务编排系统
- 维护任务状态机
- 管理 ToDoList 动态更新
- 处理异常与重试逻辑

### 架构图

```
┌─────────────────────────────────────────────┐
│          用户交互层 (User Interface)          │
│  聊天界面 | 悬浮球 | 任务详情 | 语音输入        │
└───────────────────┬─────────────────────────┘
                    │
┌───────────────────▼─────────────────────────┐
│         任务编排层 (Task Manager)            │
│  任务分析 | ToDoList | 状态机 | 异常处理      │
└───────────────────┬─────────────────────────┘
                    │
┌───────────────────▼─────────────────────────┐
│         AI 决策层 (AI Decision)              │
│  VLM 推理 | 屏幕理解 | 策略生成 | 指令输出     │
└───────────────────┬─────────────────────────┘
                    │
┌───────────────────▼─────────────────────────┐
│         感知层 (Perception)                  │
│  截图捕获 | 控件树 | OCR | 多模态融合         │
└───────────────────┬─────────────────────────┘
                    │
┌───────────────────▼─────────────────────────┐
│         执行层 (Execution)                   │
│  点击 | 滑动 | 输入 | 应用管理 | 系统操作      │
└───────────────────┬─────────────────────────┘
                    │
┌───────────────────▼─────────────────────────┐
│         权限层 (Shizuku)                     │
│  系统级权限 | 无障碍服务 | ADB Shell          │
└─────────────────────────────────────────────┘
```

---

## 🎨 功能模块设计

### 1. 用户交互界面

#### 主聊天窗口
- **类聊天软件的对话界面**,支持文本和语音输入
- **AI 回复以气泡形式展示**,包含:
  - 文字说明(当前步骤、思考过程)
  - 截图缩略图(可点击查看大图)
  - ToDoList 卡片(显示任务进度)
- 支持历史会话记录查看和搜索

#### 悬浮控制球
- **常驻显示**: 任务执行时始终悬浮在屏幕上
- **状态指示**:
  - 执行中(动画效果)
  - 暂停(橙色)
  - 成功(绿色)
  - 失败(红色)
- **交互功能**:
  - 单击: 展开任务详情面板
  - 长按: 暂停/继续任务
  - 双击: 立即终止任务
- **智能隐藏**: 任务稳定执行时自动缩小至屏幕边缘

#### 任务详情面板
从悬浮球展开,显示:
- 当前 ToDoList 及完成进度
- 最近 3 步的操作日志
- 预估剩余时间
- 快捷操作按钮(暂停/继续/终止)

---

### 2. AI 执行逻辑

#### 任务分析流程
```
用户输入 → 任务复杂度判断 → 生成执行策略
```

**简单任务(1-3 步操作)**
- 直接执行,不生成 ToDoList
- 示例: "打开微信"、"截个图"

**复杂任务(4 步以上)**
- 生成初始 ToDoList
- 展示给用户确认(可选)
- 逐步执行并更新清单

#### ToDoList 动态管理

**生成规则**
- 每个步骤描述具体、可验证
- 包含预期结果(用于执行后验证)
- 标注关键步骤(需要用户确认)

**更新机制**
- AI 每完成一步后自动检查:
  - 是否需要调整后续步骤
  - 是否需要插入新步骤
  - 是否可以跳过某些步骤
- 更新频率限制: 每完成 3 步才允许重新规划
- 所有变更记录在任务日志中

**用户交互**
- 计划修改时向用户展示变更对比
- 重大调整需要用户确认
- 用户可以手动编辑 ToDoList

#### 循环执行引擎

**执行周期**
```
截图 → 上传分析 → 获取决策 → 执行操作 → 验证结果 → 下一步
```

**状态验证**
- 每个操作后等待界面稳定(延迟 500ms - 2s)
- 对比操作前后截图,判断是否发生预期变化
- 检查是否出现错误提示(如"网络异常"、"操作失败")

**持续运行**
- 任务自动执行至完成,无需用户干预
- 支持长时间任务(最长 30 分钟,可配置)
- 后台执行时保持屏幕常亮(可选)

---

### 3. AI 操作能力

#### 基础操作
- **点击**: 支持精确坐标点击或控件点击
- **长按**: 用于触发上下文菜单
- **滑动**: 支持多方向、多速度滑动
- **输入**: 文本输入、粘贴操作
- **按键**: 返回、Home、多任务等系统按键

#### 高级能力
- **应用管理**: 打开、切换、关闭应用
- **剪贴板操作**: 读取、写入剪贴板内容
- **截图**: 捕获当前屏幕(如系统允许)
- **UI 探测**: 读取控件属性(文本、ID、位置等)
- **前台检测**: 识别当前运行的应用

#### 智能决策
- 根据屏幕内容判断下一步操作
- 识别常见 UI 模式(如登录页、列表页、详情页)
- 自适应等待时间(网络加载、动画播放)
- 模拟人类操作节奏(随机延迟 200-800ms)

---

### 4. 权限与安全体系

#### 三级权限分区

**🟢 绿区(自动执行)**
- 普通应用内操作(浏览、搜索、切换页面)
- 非敏感信息的读取和输入
- 无风险的设置调整

**🟡 黄区(需用户确认)**
- 发送消息、拨打电话
- 修改系统设置
- 安装/卸载应用
- 访问相册、通讯录

**🔴 红区(完全禁止)**
- 任何支付操作(检测到后立即暂停)
- 删除重要数据
- 授予危险权限
- 修改账户密码

#### 支付保护机制

**检测策略**
- **关键词匹配**: 识别"支付"、"付款"、"确认支付"等文字
- **应用白名单**: 支付宝、微信支付、银行 App 等
- **UI 模式识别**: 检测密码输入框、金额显示等特征

**触发行为**
- 检测到支付场景后立即暂停任务
- 弹出醒目提示: "检测到支付操作,已自动暂停"
- 将控制权交给用户
- 用户完成支付后可选择继续或终止任务

#### 隐私保护

**敏感信息处理**
- 截图上传前自动模糊化:
  - 密码输入框
  - 银行卡号
  - 身份证号
  - 手机号(后 4 位保留)
- 日志中不记录敏感输入内容

**数据存储**
- 所有截图本地存储,可设置自动清理周期
- 任务日志加密存储
- 用户可一键清除历史数据

---

### 5. 异常处理与容错

#### 异常检测机制

**卡死检测**
- 超过设定时间无界面变化(默认 10 秒)
- 触发看门狗机制,自动返回上一步或重试

**误操作识别**
- 检测到意外的应用切换
- 检测到系统崩溃对话框
- 检测到网络错误提示

**死循环预防**
- 同一步骤最多重试 3 次
- 连续 5 步无进展自动暂停
- 任务总执行时间上限(默认 30 分钟)

#### 重试与回退策略

**单步重试**
- 操作失败后等待 2 秒重试
- 最多重试 3 次
- 重试失败后执行回退

**智能回退**
- 失败时回退到最近的稳定检查点
- 保留已完成的步骤状态
- 重新规划后续路径

**用户介入**
遇到无法自动解决的问题时:
- 暂停任务
- 弹出描述性提示
- 提供建议操作
- 等待用户处理后继续

#### 日志与诊断

**操作日志**
记录每一步的:
- 时间戳
- AI 决策内容
- 执行的操作
- 执行结果
- 截图快照

**失败报告**
任务失败时自动生成报告:
- 失败步骤描述
- 错误原因分析
- 关键截图
- 建议解决方案

---

### 6. 模型配置与优化

#### API 配置
支持自定义:
- API 端点 URL
- API Key
- 模型名称(Qwen3-VL / 其他兼容模型)
- Temperature(推荐 0.2-0.4)
- Max Tokens

#### 提示词工程
- 内置优化的系统提示词
- 明确输出格式要求(JSON Schema)
- 提供屏幕状态的结构化描述
- 包含历史操作上下文

#### 响应解析
严格验证模型输出格式,提取关键信息:
- 下一步操作指令
- ToDoList 更新内容
- 任务完成判断
- 异常情况标记

#### 成本优化
- **智能缓存**: 相似界面不重复分析
- **简单操作**: 直接执行,不调用 API
- **批量操作**: 合并到一次请求
- **本地模型**: 提供本地模型选项(降低延迟和成本)

---

### 7. 高级功能

#### 任务模板系统
- 用户可保存常用任务为模板
- 支持参数化(如"给 {联系人} 发送 {消息}")
- 一键执行模板任务
- 模板市场(用户分享和下载)

#### 定时任务
- 设置任务的执行时间
- 支持单次和重复执行
- 到时自动唤醒应用并执行

#### 多任务管理
- 支持任务队列(顺序执行多个任务)
- 任务优先级设置
- 并行执行非冲突任务(实验性)

#### 学习与优化
- 记录用户的手动干预
- 分析任务执行数据
- 自动优化常用任务的执行路径
- 提供执行效率报告

---

## ⚙️ 技术要求

### 开发环境
- **Android 版本**: 8.0(API 26)或更高版本
- **必需工具**: Shizuku 已安装并激活
- **网络**: 互联网连接(用于 API 调用)

### 性能指标
- **单步操作响应时间**: < 5 秒
- **内存占用**: < 200MB
- **截图上传大小**: < 500KB(自动压缩)
- **日志存储**: 可配置上限(默认 100MB)

### 兼容性
- 支持主流 Android UI(MIUI、ColorOS、OneUI 等)
- 兼容不同屏幕分辨率和比例
- 适配深色模式和浅色模式

---

## 👤 用户体验设计

### 首次使用引导
1. 引导用户激活 Shizuku
2. 授予必要权限
3. 配置 API 密钥
4. 完成简单示例任务(如"打开设置")

### 交互原则
- **减少等待感知**: 显示实时进度
- **透明化 AI 决策**: 让用户理解 AI 在做什么
- **可控性**: 随时暂停/终止
- **可解释性**: 失败时说明原因

---

## 🎯 核心优势总结

1. **自然交互**: 用户只需描述需求,AI 自动规划和执行
2. **智能决策**: 结合视觉理解和结构分析,准确识别屏幕状态
3. **可靠执行**: 完善的异常处理和回退机制,保证任务完成率
4. **安全可控**: 三级权限体系,特别是支付保护机制确保用户资金安全
5. **易于扩展**: 模块化架构便于添加新功能

通过 MVP 快速验证核心技术可行性后,可以逐步完善功能,最终打造出一款真正实用的 AI 助手应用。
